<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í…Œë§ˆ ì‹œìŠ¤í…œ ì¿ í‚¤ í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .result {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¨ í…Œë§ˆ ì‹œìŠ¤í…œ ì¿ í‚¤ ì €ì¥ í…ŒìŠ¤íŠ¸</h1>
        <p>Termix í…Œë§ˆ ì‹œìŠ¤í…œì˜ ì¿ í‚¤ ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° ê¸°ëŠ¥ì„ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.</p>

        <div class="test-section">
            <h3>1. í˜„ì¬ ì¿ í‚¤ ìƒíƒœ</h3>
            <button onclick="showCurrentCookie()">í˜„ì¬ ì¿ í‚¤ í™•ì¸</button>
            <div id="current-cookie" class="result"></div>
        </div>

        <div class="test-section">
            <h3>2. í…Œë§ˆ ì„¤ì • ì €ì¥ í…ŒìŠ¤íŠ¸</h3>
            <button onclick="saveLight()">Light ëª¨ë“œ ì €ì¥</button>
            <button onclick="saveDark()">Dark ëª¨ë“œ ì €ì¥</button>
            <button onclick="saveSystem()">System ëª¨ë“œ ì €ì¥</button>
            <button onclick="saveCustom()">ì»¤ìŠ¤í…€ ì„¤ì • ì €ì¥</button>
            <div id="save-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>3. í…Œë§ˆ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° í…ŒìŠ¤íŠ¸</h3>
            <button onclick="loadTheme()">í…Œë§ˆ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°</button>
            <div id="load-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>4. ì‹œìŠ¤í…œ í…Œë§ˆ ê°ì§€</h3>
            <button onclick="detectSystem()">ì‹œìŠ¤í…œ í…Œë§ˆ ê°ì§€</button>
            <div id="system-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>5. ê¸°ì¡´ ê¸°ëŠ¥ ì˜í–¥ë„ í…ŒìŠ¤íŠ¸</h3>
            <button onclick="testExistingCookies()">ê¸°ì¡´ ì¿ í‚¤ì™€ì˜ ë…ë¦½ì„± í™•ì¸</button>
            <div id="independence-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>6. ì¿ í‚¤ ì´ˆê¸°í™”</h3>
            <button onclick="clearCookie()">í…Œë§ˆ ì¿ í‚¤ ì‚­ì œ</button>
            <div id="clear-result" class="result"></div>
        </div>
    </div>

    <script type="module">
        // í…Œë§ˆ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤ (ì‹¤ì œë¡œëŠ” import í•  ê²ƒ)
        const THEME_COOKIE_NAME = 'termix-theme';
        const THEME_COOKIE_EXPIRY_DAYS = 365;

        const DEFAULT_THEME_SETTINGS = {
            mode: 'system',
            systemTheme: 'light',
            customColors: {},
            terminalTheme: 'default',
            editorTheme: 'default',
            lastUpdated: new Date().toISOString(),
        };

        function getThemeFromCookie() {
            try {
                const cookieValue = document.cookie
                    .split('; ')
                    .reduce((r, v) => {
                        const parts = v.split('=');
                        return parts[0] === THEME_COOKIE_NAME ? decodeURIComponent(parts[1]) : r;
                    }, "");

                if (!cookieValue) {
                    return DEFAULT_THEME_SETTINGS;
                }

                const parsed = JSON.parse(cookieValue);
                return {
                    ...DEFAULT_THEME_SETTINGS,
                    ...parsed,
                    lastUpdated: parsed.lastUpdated || new Date().toISOString(),
                };
            } catch (error) {
                console.warn('Failed to parse theme cookie:', error);
                return DEFAULT_THEME_SETTINGS;
            }
        }

        function saveThemeToCookie(settings) {
            try {
                const currentSettings = getThemeFromCookie();
                const updatedSettings = {
                    ...currentSettings,
                    ...settings,
                    lastUpdated: new Date().toISOString(),
                };

                const jsonValue = JSON.stringify(updatedSettings);
                const expires = new Date(Date.now() + THEME_COOKIE_EXPIRY_DAYS * 864e5).toUTCString();
                
                document.cookie = `${THEME_COOKIE_NAME}=${encodeURIComponent(jsonValue)}; expires=${expires}; path=/`;
                return updatedSettings;
            } catch (error) {
                console.error('Failed to save theme to cookie:', error);
                return null;
            }
        }

        function detectSystemTheme() {
            if (window.matchMedia) {
                return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            }
            return 'light';
        }

        function clearThemeCookie() {
            document.cookie = `${THEME_COOKIE_NAME}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/`;
        }

        // ì „ì—­ í•¨ìˆ˜ë“¤
        window.showCurrentCookie = function() {
            const result = document.getElementById('current-cookie');
            const allCookies = document.cookie || '(ë¹ˆ ì¿ í‚¤)';
            result.innerHTML = `<strong>ì „ì²´ ì¿ í‚¤:</strong><br>${allCookies}<br><br>`;
            
            const themeSettings = getThemeFromCookie();
            result.innerHTML += `<strong>í…Œë§ˆ ì„¤ì •:</strong><br>${JSON.stringify(themeSettings, null, 2)}`;
        };

        window.saveLight = function() {
            const result = document.getElementById('save-result');
            const saved = saveThemeToCookie({ mode: 'light' });
            result.innerHTML = `<span class="success">âœ… Light ëª¨ë“œ ì €ì¥ ì™„ë£Œ</span><br>${JSON.stringify(saved, null, 2)}`;
        };

        window.saveDark = function() {
            const result = document.getElementById('save-result');
            const saved = saveThemeToCookie({ mode: 'dark', terminalTheme: 'dark-theme' });
            result.innerHTML = `<span class="success">âœ… Dark ëª¨ë“œ ì €ì¥ ì™„ë£Œ</span><br>${JSON.stringify(saved, null, 2)}`;
        };

        window.saveSystem = function() {
            const result = document.getElementById('save-result');
            const saved = saveThemeToCookie({ mode: 'system' });
            result.innerHTML = `<span class="success">âœ… System ëª¨ë“œ ì €ì¥ ì™„ë£Œ</span><br>${JSON.stringify(saved, null, 2)}`;
        };

        window.saveCustom = function() {
            const result = document.getElementById('save-result');
            const customSettings = {
                mode: 'dark',
                customColors: {
                    primary: '#ff6b35',
                    secondary: '#4ecdc4',
                    accent: '#45b7d1'
                },
                terminalTheme: 'custom-dark',
                editorTheme: 'monokai'
            };
            const saved = saveThemeToCookie(customSettings);
            result.innerHTML = `<span class="success">âœ… ì»¤ìŠ¤í…€ ì„¤ì • ì €ì¥ ì™„ë£Œ</span><br>${JSON.stringify(saved, null, 2)}`;
        };

        window.loadTheme = function() {
            const result = document.getElementById('load-result');
            const theme = getThemeFromCookie();
            result.innerHTML = `<strong>ë¶ˆëŸ¬ì˜¨ í…Œë§ˆ ì„¤ì •:</strong><br>${JSON.stringify(theme, null, 2)}`;
        };

        window.detectSystem = function() {
            const result = document.getElementById('system-result');
            const systemTheme = detectSystemTheme();
            result.innerHTML = `<strong>ê°ì§€ëœ ì‹œìŠ¤í…œ í…Œë§ˆ:</strong> ${systemTheme}`;
        };

        window.testExistingCookies = function() {
            const result = document.getElementById('independence-result');
            
            // ê¸°ì¡´ ì¿ í‚¤ ì„¤ì • (jwt ë“±)
            document.cookie = 'jwt=test-jwt-token; path=/';
            document.cookie = 'other-setting=test-value; path=/';
            
            // í…Œë§ˆ ì¿ í‚¤ ì €ì¥
            saveThemeToCookie({ mode: 'dark' });
            
            // ëª¨ë“  ì¿ í‚¤ í™•ì¸
            const allCookies = document.cookie;
            const hasJwt = allCookies.includes('jwt=test-jwt-token');
            const hasOther = allCookies.includes('other-setting=test-value');
            const hasTheme = allCookies.includes(THEME_COOKIE_NAME);
            
            if (hasJwt && hasOther && hasTheme) {
                result.innerHTML = `<span class="success">âœ… ëª¨ë“  ì¿ í‚¤ê°€ ë…ë¦½ì ìœ¼ë¡œ ì •ìƒ ì‘ë™</span><br>JWT: ${hasJwt}<br>ê¸°íƒ€: ${hasOther}<br>í…Œë§ˆ: ${hasTheme}`;
            } else {
                result.innerHTML = `<span class="error">âŒ ì¿ í‚¤ ê°„ì„­ ë°œìƒ</span><br>JWT: ${hasJwt}<br>ê¸°íƒ€: ${hasOther}<br>í…Œë§ˆ: ${hasTheme}`;
            }
        };

        window.clearCookie = function() {
            const result = document.getElementById('clear-result');
            clearThemeCookie();
            result.innerHTML = '<span class="success">âœ… í…Œë§ˆ ì¿ í‚¤ ì‚­ì œ ì™„ë£Œ</span>';
        };

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ìƒíƒœ í‘œì‹œ
        window.addEventListener('load', () => {
            showCurrentCookie();
        });
    </script>
</body>
</html>